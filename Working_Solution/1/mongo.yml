---
- name: Install and configure MongoDB
  hosts: all   
  become: true
  
  tasks:
    - name: Update package cache
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: reboot if kernel updated
      command: /sbin/reboot
      async: 1
      poll: 0
      ignore_errors: true
      register: reboot
      when: reboot_required.stat.exists
      changed_when: reboot.rc == 1

      # - name: Reboot the machine
      #   become: true
      #   reboot:
      #     reboot_timeout: 300
      #     pre_reboot_delay: 0
      #     post_reboot_delay: 30


    - name: Install MongoDB   # Default port is 27017
      apt:
        update_cache: yes # Run the equivalent of apt-get update before the operation. Can be run as part of the package installation or as a separate step.
        name: mongodb
        state: started
        
    - name: Start MongoDB service
      service:
        name: mongodb
        state: started
        enabled: yes  # Whether the service should start on boot.

    - name: Capture and expose IP address
      shell: hostname -I
      register: ip_address_result

    - name: Set IP address as environment variable
      set_fact:
        mongo_ip: "{{ ip_address_result.stdout }}"

    - name: Mongodb.conf file update
     lineinfile:
       path: /etc/mongodb.conf
       regexp: '^bindIp'
       line: 'bindIp: "{{ mongo_ip }}"'
       state: present   # Thanks to this option I add the line if it doesn't exist at all

######### Client #########

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
      changed_when: false

    - name: Reboot the system
      command: sudo reboot
      when: reboot_required.stat.exists

    - name: Install WireGuard and OpenResolv
      apt:
        name:
          - wireguard
          - openresolv
        state: present
        update_cache: yes
      become: true

    - name: Copy file from VPN server
      fetch:
        src: "/home/vagrant/algo/configs/{{ vpn_ip }}/wireguard/mongo.conf"
        dest: "/home/vagrant/"
        flat: yes
        fail_on_missing: yes
      vars:
        vpn_server_ip: "<ip_address_of_vpnserver>"

    - name: Install WireGuard configuration file
      copy:
        src: "/home/vagrant/mongo.conf"
        dest: "/etc/wireguard/wg0.conf"
        owner: root
        group: root
        mode: 0600

    - name: Start WireGuard VPN
      systemd:
        name: "wg-quick@wg0"
        state: started
        enabled: yes

